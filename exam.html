<!DOCTYPE html>
<html lang="en">
<head>
    <script src="suppress-tailwind-warning.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles.css?v=1.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Exam | JambGenius ðŸ’¯</title>
    <meta name="description" content="Full JAMB mock exam simulation with 180 questions and 2-hour timer">
    
    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-config.js"></script>
    <script src="supabaseClient.js"></script>
    <script src="content-protection.js"></script>
    <script src="calculator.js"></script>
    <script src="anti-cheat.js"></script>
    <script type="module">
        import './firebase-init.js';
        import './auth-state.js';
        import './auth-modal.js';
        import './bookmarks.js';
        import './streak-tracker.js';
    </script>
</head>
<body class="bg-gray-50 font-sans">
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-graduation-cap text-2xl text-primary-600 mr-2"></i>
                        <span class="text-xl font-bold text-gray-900">JambGenius ðŸ’¯</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="timer" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg font-bold text-lg">
                        <i class="fas fa-clock mr-2"></i>
                        <span id="timeDisplay">2:00:00</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-primary-600 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600 text-lg">Preparing your exam...</p>
            <p class="text-gray-500 text-sm mt-2">Loading 180 questions</p>
        </div>
    </div>

    <div id="setupAlert" class="hidden min-h-screen flex items-center justify-center p-2 sm:p-4">
        <div class="max-w-2xl w-full bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 sm:p-8">
            <div class="flex items-start space-x-4">
                <i class="fas fa-exclamation-triangle text-3xl text-yellow-600 mt-1"></i>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Supabase Setup Required</h2>
                    <p class="text-gray-700 mb-4">To load exam questions from your database, you need to configure Supabase:</p>
                    <ol class="list-decimal list-inside space-y-2 text-gray-700 mb-6">
                        <li>Create a Supabase project at <a href="https://supabase.com" target="_blank" class="text-primary-600 hover:underline">supabase.com</a></li>
                        <li>Create a <code class="bg-gray-200 px-2 py-1 rounded">questions</code> table with your questions</li>
                        <li>Get your project URL and anon key from Supabase settings</li>
                        <li>Update <code class="bg-gray-200 px-2 py-1 rounded">config.js</code> with your credentials</li>
                    </ol>
                    <div class="bg-white rounded-lg p-4 border border-yellow-300 mb-4">
                        <p class="text-sm font-semibold text-gray-900 mb-2">For now, you can:</p>
                        <button id="useMockDataBtn" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                            <i class="fas fa-play mr-2"></i>Continue with Sample Questions
                        </button>
                    </div>
                    <a href="exam-mode-subjects.html" class="text-primary-600 hover:text-primary-700 font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i>Back to Subject Selection
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div id="examInterface" class="hidden">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-xl shadow-sm p-6 sticky top-24">
                        <h3 class="font-bold text-gray-900 mb-4">Question Navigator</h3>
                        <div class="mb-4">
                            <div class="text-sm text-gray-600 mb-2">Progress</div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-primary-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                <span id="answeredCount">0</span>/180 answered
                            </div>
                        </div>
                        
                        <div id="subjectTabs" class="space-y-2 mb-4">
                        </div>

                        <div id="questionGrid" class="grid grid-cols-5 gap-2">
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3">
                    <div class="bg-white rounded-xl shadow-sm p-8">
                        <div class="mb-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <span class="text-sm font-semibold text-primary-600" id="currentSubject">Use of English</span>
                                    <div class="text-sm text-gray-500">Question <span id="currentQuestionNum">1</span> of <span id="totalQuestions">180</span></div>
                                </div>
                                <button id="aiExplainBtn" class="text-gray-400 hover:text-purple-500 transition-colors" title="Get AI explanation">
                                    <i class="fas fa-lightbulb text-lg"></i>
                                </button>
                            </div>
                            <h2 class="text-xl font-semibold text-gray-900" id="questionText">Loading question...</h2>
                        </div>

                        <div id="optionsContainer" class="space-y-3 mb-8">
                        </div>

                        <div class="flex justify-between items-center pt-6 border-t border-gray-200">
                            <button id="prevBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-arrow-left mr-2"></i>Previous
                            </button>

                            <button id="submitExamBtn" class="px-8 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-bold">
                                <i class="fas fa-check-circle mr-2"></i>Submit Exam
                            </button>

                            <button id="nextBtn" class="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                                Next<i class="fas fa-arrow-right ml-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resultsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-8 max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-8">
                <div class="w-24 h-24 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trophy text-5xl text-white"></i>
                </div>
                <h2 class="text-4xl font-bold text-gray-900 mb-2">Exam Complete!</h2>
                <p class="text-gray-600">Here's how you performed</p>
            </div>

            <div class="bg-gradient-to-br from-primary-50 to-blue-50 rounded-xl p-8 mb-8">
                <div class="text-center">
                    <div class="text-6xl font-bold text-primary-600 mb-2" id="totalScore">0</div>
                    <div class="text-gray-600 text-lg mb-4">Total Score (out of 400)</div>
                    <div class="text-3xl font-bold text-gray-900" id="percentage">0%</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-green-50 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-green-600" id="correctAnswers">0</div>
                    <div class="text-gray-600 text-sm">Correct</div>
                </div>
                <div class="bg-red-50 rounded-xl p-4 text-center">
                    <div class="text-3xl font-bold text-red-600" id="wrongAnswers">0</div>
                    <div class="text-gray-600 text-sm">Wrong</div>
                </div>
            </div>

            <div id="subjectBreakdown" class="space-y-3 mb-8">
            </div>

            <div class="space-y-3">
                <button id="downloadPdfBtn" class="w-full bg-green-600 text-white py-4 rounded-lg hover:bg-green-700 transition-colors font-bold text-lg">
                    <i class="fas fa-download mr-2"></i>Download Result as PDF
                </button>
                <button id="newExamBtn" class="w-full bg-primary-600 text-white py-4 rounded-lg hover:bg-primary-700 transition-colors font-bold text-lg">
                    <i class="fas fa-redo mr-2"></i>Take Another Exam
                </button>
                <a href="index.html" class="block w-full bg-white border-2 border-gray-300 text-gray-700 py-4 rounded-lg hover:bg-gray-50 transition-colors font-semibold text-lg text-center">
                    Back to Home
                </a>
            </div>
        </div>
    </div>

    <script>
        const MOCK_QUESTIONS_EXAM = {
            english: { id: 1, subject: 'english', question: 'Choose the correct option: She _____ to school every day.', option_a: 'go', option_b: 'goes', option_c: 'going', option_d: 'gone', correct_answer: 'B', explanation: 'Use "goes" for third person singular in present tense.' },
            mathematics: { id: 1, subject: 'mathematics', question: 'Solve: 5 + 3 Ã— 2 = ?', option_a: '16', option_b: '11', option_c: '10', option_d: '13', correct_answer: 'B', explanation: 'Following BODMAS: 3 Ã— 2 = 6, then 5 + 6 = 11' },
            physics: { id: 1, subject: 'physics', question: 'What is the SI unit of energy?', option_a: 'Watt', option_b: 'Joule', option_c: 'Newton', option_d: 'Kelvin', correct_answer: 'B', explanation: 'The Joule (J) is the SI unit of energy.' },
            chemistry: { id: 1, subject: 'chemistry', question: 'The atomic number of an element represents:', option_a: 'Number of neutrons', option_b: 'Number of protons', option_c: 'Atomic mass', option_d: 'Number of electrons', correct_answer: 'B', explanation: 'Atomic number equals the number of protons in the nucleus.' },
            biology: { id: 1, subject: 'biology', question: 'Which organelle controls cell activities?', option_a: 'Mitochondria', option_b: 'Nucleus', option_c: 'Ribosome', option_d: 'Vacuole', correct_answer: 'B', explanation: 'The nucleus contains DNA and controls all cell activities.' },
            government: { id: 1, subject: 'government', question: 'The separation of powers means:', option_a: 'Division of government into three branches', option_b: 'Sharing power with states', option_c: 'Military control', option_d: 'Federal system', correct_answer: 'A', explanation: 'Separation of powers divides government into legislative, executive, and judicial branches.' },
            economics: { id: 1, subject: 'economics', question: 'Scarcity in economics means:', option_a: 'Unlimited resources', option_b: 'Limited resources and unlimited wants', option_c: 'No demand', option_d: 'Excess supply', correct_answer: 'B', explanation: 'Scarcity occurs when resources are limited but wants are unlimited.' },
            commerce: { id: 1, subject: 'commerce', question: 'A cheque that can only be paid into a bank account is:', option_a: 'Open cheque', option_b: 'Crossed cheque', option_c: 'Bearer cheque', option_d: 'Stale cheque', correct_answer: 'B', explanation: 'A crossed cheque must be deposited into a bank account.' },
            literature: { id: 1, subject: 'literature', question: 'A poem with 14 lines is called:', option_a: 'Haiku', option_b: 'Sonnet', option_c: 'Ballad', option_d: 'Ode', correct_answer: 'B', explanation: 'A sonnet is a 14-line poem, usually with a specific rhyme scheme.' },
            geography: { id: 1, subject: 'geography', question: 'The imaginary line at 0Â° latitude is called:', option_a: 'Prime Meridian', option_b: 'Equator', option_c: 'Tropic of Cancer', option_d: 'Arctic Circle', correct_answer: 'B', explanation: 'The Equator is at 0Â° latitude and divides Earth into Northern and Southern hemispheres.' },
            crs: { id: 1, subject: 'crs', question: 'The first book in the Bible is:', option_a: 'Exodus', option_b: 'Genesis', option_c: 'Leviticus', option_d: 'Matthew', correct_answer: 'B', explanation: 'Genesis is the first book of the Bible.' },
            civic: { id: 1, subject: 'civic', question: 'The fundamental human rights are contained in which chapter of the Nigerian Constitution?', option_a: 'Chapter 2', option_b: 'Chapter 4', option_c: 'Chapter 1', option_d: 'Chapter 3', correct_answer: 'B', explanation: 'Chapter 4 of the Nigerian Constitution contains fundamental human rights.' }
        };

        let examQuestions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let selectedSubjects = [];
        let timeRemaining = 7200;
        let timerInterval = null;
        let useMockData = false;
        let antiCheat = null;

        const urlParams = new URLSearchParams(window.location.search);
        const subjectsParam = urlParams.get('subjects');
        
        if (subjectsParam) {
            selectedSubjects = subjectsParam.split(',');
        } else {
            selectedSubjects = ['english', 'mathematics', 'physics', 'chemistry'];
        }

        antiCheat = new AntiCheatSystem((violations) => {
            alert(`Maximum violations reached (${violations.length} violations). Your exam will be submitted automatically.`);
            submitExam();
        });

        async function initializeExam() {
            const supabaseConfigured = isSupabaseConfigured();
            
            if (!supabaseConfigured) {
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('setupAlert').classList.remove('hidden');
                
                document.getElementById('useMockDataBtn').addEventListener('click', () => {
                    useMockData = true;
                    document.getElementById('setupAlert').classList.add('hidden');
                    loadExamQuestions();
                });
                
                return;
            }
            
            await loadExamQuestions();
        }

        async function loadExamQuestions() {
            try {
                let questions = null;
                
                if (!useMockData) {
                    questions = await loadExamQuestionsFromSupabase(selectedSubjects);
                }
                
                if (!questions || questions.length === 0) {
                    questions = [];
                    selectedSubjects.forEach(subject => {
                        const count = subject.toLowerCase() === 'english' ? 60 : 40;
                        const mockQ = MOCK_QUESTIONS_EXAM[subject.toLowerCase()] || MOCK_QUESTIONS_EXAM.english;
                        
                        for (let i = 0; i < count; i++) {
                            questions.push({
                                ...mockQ,
                                id: questions.length + 1,
                                subject: subject
                            });
                        }
                    });
                }
                
                examQuestions = questions;
                userAnswers = new Array(examQuestions.length).fill(null);
                
                document.getElementById('loadingScreen').classList.add('hidden');
                
                showExamRules(() => {
                    document.getElementById('examInterface').classList.remove('hidden');
                    initializeUI();
                    renderQuestion();
                    startTimer();
                    antiCheat.startMonitoring();
                });
            } catch (error) {
                console.error('Error loading exam questions:', error);
                alert('Failed to load exam questions. Please try again.');
            }
        }

        function initializeUI() {
            const subjectTabs = document.getElementById('subjectTabs');
            const questionGrid = document.getElementById('questionGrid');
            
            selectedSubjects.forEach(subject => {
                const button = document.createElement('button');
                button.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors text-sm font-medium text-gray-700';
                button.textContent = capitalizeFirst(subject);
                button.addEventListener('click', () => {
                    const firstQuestionOfSubject = examQuestions.findIndex(q => q.subject.toLowerCase() === subject.toLowerCase());
                    if (firstQuestionOfSubject !== -1) {
                        currentQuestionIndex = firstQuestionOfSubject;
                        renderQuestion();
                    }
                });
                subjectTabs.appendChild(button);
            });
            
            for (let i = 0; i < examQuestions.length; i++) {
                const btn = document.createElement('button');
                btn.className = 'w-10 h-10 rounded-lg border-2 border-gray-300 hover:border-primary-500 transition-all text-sm font-semibold';
                btn.textContent = i + 1;
                btn.dataset.index = i;
                btn.addEventListener('click', () => {
                    currentQuestionIndex = i;
                    renderQuestion();
                });
                questionGrid.appendChild(btn);
            }
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function renderQuestion() {
            const question = examQuestions[currentQuestionIndex];
            
            document.getElementById('currentSubject').textContent = capitalizeFirst(question.subject);
            document.getElementById('currentQuestionNum').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQuestions').textContent = examQuestions.length;
            document.getElementById('questionText').textContent = question.question;
            
            const optionsContainer = document.getElementById('optionsContainer');
            optionsContainer.innerHTML = '';
            
            const options = ['A', 'B', 'C', 'D'];
            options.forEach(opt => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option-btn p-4 border-2 border-gray-200 rounded-lg cursor-pointer hover:border-primary-500 hover:bg-primary-50 transition-all';
                optionDiv.dataset.option = opt;
                
                const isSelected = userAnswers[currentQuestionIndex] === opt;
                if (isSelected) {
                    optionDiv.classList.add('border-primary-500', 'bg-primary-100');
                }
                
                optionDiv.innerHTML = `
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full border-2 ${isSelected ? 'border-primary-600 bg-primary-600' : 'border-gray-300'} flex items-center justify-center mr-3 font-semibold ${isSelected ? 'text-white' : ''}">
                            ${opt}
                        </div>
                        <div class="flex-1">${question[`option_${opt.toLowerCase()}`]}</div>
                    </div>
                `;
                
                optionDiv.addEventListener('click', () => selectOption(opt));
                optionsContainer.appendChild(optionDiv);
            });
            
            updateNavigation();
            updateQuestionGrid();
            updateProgress();
        }

        function selectOption(option) {
            userAnswers[currentQuestionIndex] = option;
            renderQuestion();
        }

        function updateNavigation() {
            document.getElementById('prevBtn').disabled = currentQuestionIndex === 0;
            document.getElementById('nextBtn').disabled = currentQuestionIndex === examQuestions.length - 1;
        }

        function updateQuestionGrid() {
            const gridButtons = document.querySelectorAll('#questionGrid button');
            gridButtons.forEach((btn, index) => {
                btn.className = 'w-10 h-10 rounded-lg border-2 transition-all text-sm font-semibold';
                
                if (userAnswers[index]) {
                    btn.className += ' bg-green-100 border-green-500 text-green-700';
                } else if (index === currentQuestionIndex) {
                    btn.className += ' bg-primary-100 border-primary-500 text-primary-700';
                } else {
                    btn.className += ' border-gray-300 hover:border-primary-500 text-gray-700';
                }
            });
        }

        function updateProgress() {
            const answered = userAnswers.filter(a => a !== null).length;
            const percentage = (answered / examQuestions.length) * 100;
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('answeredCount').textContent = answered;
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                const hours = Math.floor(timeRemaining / 3600);
                const minutes = Math.floor((timeRemaining % 3600) / 60);
                const seconds = timeRemaining % 60;
                
                document.getElementById('timeDisplay').textContent = 
                    `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    submitExam();
                }
                
                if (timeRemaining <= 300) {
                    document.getElementById('timer').classList.add('animate-pulse');
                }
            }, 1000);
        }

        function submitExam() {
            clearInterval(timerInterval);
            if (antiCheat) {
                antiCheat.stopMonitoring();
            }
            
            let correctCount = 0;
            const subjectScores = {};
            
            selectedSubjects.forEach(subject => {
                subjectScores[subject] = { correct: 0, total: 0 };
            });
            
            examQuestions.forEach((question, index) => {
                const subject = question.subject.toLowerCase();
                const isCorrect = userAnswers[index] === question.correct_answer;
                
                if (isCorrect) {
                    correctCount++;
                    subjectScores[subject].correct++;
                }
                subjectScores[subject].total++;
            });
            
            const totalScore = Math.round((correctCount / examQuestions.length) * 400);
            const percentage = Math.round((correctCount / examQuestions.length) * 100);
            
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('percentage').textContent = `${percentage}%`;
            document.getElementById('correctAnswers').textContent = correctCount;
            document.getElementById('wrongAnswers').textContent = examQuestions.length - correctCount;
            
            const breakdown = document.getElementById('subjectBreakdown');
            breakdown.innerHTML = '<h3 class="font-bold text-gray-900 mb-3">Subject Breakdown</h3>';
            
            Object.entries(subjectScores).forEach(([subject, scores]) => {
                const subjectPercentage = Math.round((scores.correct / scores.total) * 100);
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-4';
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-semibold text-gray-900">${capitalizeFirst(subject)}</span>
                        <span class="text-primary-600 font-bold">${subjectPercentage}%</span>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-600">
                        <span>${scores.correct}/${scores.total} correct</span>
                    </div>
                `;
                breakdown.appendChild(div);
            });
            
            document.getElementById('resultsModal').classList.remove('hidden');
        }

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentQuestionIndex < examQuestions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            }
        });

        document.getElementById('submitExamBtn').addEventListener('click', () => {
            const answered = userAnswers.filter(a => a !== null).length;
            const unanswered = examQuestions.length - answered;
            
            let message = 'Are you sure you want to submit your exam?';
            if (unanswered > 0) {
                message = `You have ${unanswered} unanswered questions. Are you sure you want to submit?`;
            }
            
            if (confirm(message)) {
                submitExam();
            }
        });

        document.getElementById('newExamBtn').addEventListener('click', () => {
            window.location.href = 'exam-mode-subjects.html';
        });

        document.getElementById('downloadPdfBtn').addEventListener('click', () => {
            generatePdfReport();
        });

        function generatePdfReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current date and time
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-NG', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            const timeStr = now.toLocaleTimeString('en-NG', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Get results data
            const totalScore = document.getElementById('totalScore').textContent;
            const percentage = document.getElementById('percentage').textContent;
            const correctAnswers = document.getElementById('correctAnswers').textContent;
            const wrongAnswers = document.getElementById('wrongAnswers').textContent;
            
            // Calculate subject scores
            const subjectScores = {};
            selectedSubjects.forEach(subject => {
                subjectScores[subject] = { correct: 0, total: 0 };
            });
            
            examQuestions.forEach((question, index) => {
                const subject = question.subject.toLowerCase();
                if (!subjectScores[subject]) {
                    subjectScores[subject] = { correct: 0, total: 0 };
                }
                
                const isCorrect = userAnswers[index] === question.correct_answer;
                if (isCorrect) {
                    subjectScores[subject].correct++;
                }
                subjectScores[subject].total++;
            });
            
            // Colors
            const primaryColor = [37, 99, 235];
            const greenColor = [34, 197, 94];
            const redColor = [239, 68, 68];
            const grayColor = [107, 114, 128];
            
            // Header with gradient background
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 45, 'F');
            
            // Logo and Title
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('JambGenius', 105, 20, { align: 'center' });
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'normal');
            doc.text('JAMB Mock Exam Result', 105, 32, { align: 'center' });
            
            // Date and Time
            doc.setFontSize(10);
            doc.text(dateStr + ' at ' + timeStr, 105, 40, { align: 'center' });
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            
            // Overall Score Section
            let yPos = 60;
            
            // Score box with border
            doc.setDrawColor(...primaryColor);
            doc.setLineWidth(0.5);
            doc.roundedRect(15, yPos, 180, 35, 3, 3);
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Overall Performance', 105, yPos + 10, { align: 'center' });
            
            doc.setFontSize(32);
            doc.setTextColor(...primaryColor);
            doc.text(totalScore, 70, yPos + 27, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(...grayColor);
            doc.text('Total Score', 70, yPos + 32, { align: 'center' });
            
            doc.setFontSize(32);
            doc.setTextColor(...primaryColor);
            doc.text(percentage, 140, yPos + 27, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(...grayColor);
            doc.text('Percentage', 140, yPos + 32, { align: 'center' });
            
            // Correct vs Wrong
            yPos += 45;
            
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text('Answer Summary', 15, yPos);
            
            yPos += 8;
            
            // Correct box
            doc.setFillColor(...greenColor);
            doc.setDrawColor(...greenColor);
            doc.roundedRect(15, yPos, 85, 20, 2, 2, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.text('Correct Answers', 57.5, yPos + 8, { align: 'center' });
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(correctAnswers, 57.5, yPos + 16, { align: 'center' });
            
            // Wrong box
            doc.setFillColor(...redColor);
            doc.setDrawColor(...redColor);
            doc.roundedRect(110, yPos, 85, 20, 2, 2, 'FD');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Wrong Answers', 152.5, yPos + 8, { align: 'center' });
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(wrongAnswers, 152.5, yPos + 16, { align: 'center' });
            
            // Subject Breakdown
            yPos += 30;
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('Subject Breakdown', 15, yPos);
            
            yPos += 8;
            
            // Table headers
            doc.setFillColor(240, 240, 240);
            doc.rect(15, yPos, 180, 10, 'F');
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text('Subject', 20, yPos + 7);
            doc.text('Score', 120, yPos + 7);
            doc.text('Percentage', 160, yPos + 7);
            
            yPos += 10;
            
            // Subject rows
            doc.setFont(undefined, 'normal');
            Object.entries(subjectScores).forEach(([subject, scores], index) => {
                const subjectPercentage = Math.round((scores.correct / scores.total) * 100);
                
                // Alternating row colors
                if (index % 2 === 0) {
                    doc.setFillColor(250, 250, 250);
                    doc.rect(15, yPos, 180, 10, 'F');
                }
                
                doc.setTextColor(0, 0, 0);
                doc.text(capitalizeFirst(subject), 20, yPos + 7);
                doc.text(`${scores.correct}/${scores.total}`, 120, yPos + 7);
                
                // Color code percentage
                if (subjectPercentage >= 70) {
                    doc.setTextColor(...greenColor);
                } else if (subjectPercentage >= 50) {
                    doc.setTextColor(245, 158, 11); // Orange
                } else {
                    doc.setTextColor(...redColor);
                }
                doc.setFont(undefined, 'bold');
                doc.text(`${subjectPercentage}%`, 160, yPos + 7);
                doc.setFont(undefined, 'normal');
                
                yPos += 10;
            });
            
            // Footer
            yPos = 270;
            doc.setDrawColor(200, 200, 200);
            doc.line(15, yPos, 195, yPos);
            
            yPos += 8;
            doc.setFontSize(9);
            doc.setTextColor(...grayColor);
            doc.setFont(undefined, 'italic');
            doc.text('Generated by JambGenius - Nigeria\'s Premier JAMB Preparation Platform', 105, yPos, { align: 'center' });
            doc.text('Â© 2025 JambGenius. All rights reserved.', 105, yPos + 5, { align: 'center' });
            
            // Save the PDF
            const filename = `JambGenius_Exam_Result_${dateStr.replace(/\s/g, '_')}.pdf`;
            doc.save(filename);
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        window.addEventListener('beforeunload', (e) => {
            if (timerInterval) {
                e.preventDefault();
                e.returnValue = 'Your exam is in progress. Are you sure you want to leave?';
            }
        });

        initializeExam();
    </script>
</body>
</html>
